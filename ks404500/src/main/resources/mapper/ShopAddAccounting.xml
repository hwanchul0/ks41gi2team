<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart41_teamtest.mapper.ShopAddAccountingMapper">

<!-- 유경 - 쇼핑몰  매출 등록-->
<select id="getAddIncome"  resultType="ShopAddAccounting">
	SELECT
		if(ISNULL(i.shopIncomeCode), '발행대상', '발행완료') AS addIncome,
		i.shopIncomeCode as shopIncomeCode,
		r.releaseCode,
		o.shopOrderCode,
		o.shopSlipNumber,
		o.shopOrderAmount,
		o.goodsPaymentAmount,
		ROUND((o.goodsPaymentAmount/1.1),0) AS nontax,
		cast(if(isnull(re.shopRefundCode),1,0)as INT) AS checkRefund,
		(ROUND((o.goodsPaymentAmount/1.1),0) * cast(if(isnull(re.shopRefundCode),1,0)as INT)) AS renontax,
		ROUND((ROUND((o.goodsPaymentAmount/1.1),0) * cast(if(isnull(re.shopRefundCode),1,0)as INT)) * 0.1,0) AS retax,
		c.shopPaymentDate,
		re.shopRefundCode,
		re.shopRefundDate,
		left(replace(CONCAT('쇼핑몰_상품_',o.shopSlipNumber),'전표',''),16) AS groupslip,
		r.shopPaymentCheckCode
	FROM
		k2_release AS r
		left join
		k2_shop_order AS o
		ON
		o.shopOrderCode = r.shopOrderCode
		left JOIN
		k2_shop_refund AS re
		ON
		re.releaseCode = r.releaseCode
		LEFT join
		k2_shop_paymentCheck AS c
		on
		c.shopPaymentCheckCode = r.shopPaymentCheckCode
		LEFT join
		k2_shop_income AS i
		on
		i.releaseCode = r.releaseCode
	ORDER BY (i.shopIncomeCode IS NOT NULL)
	, i.shopIncomeCode DESC

</select>

	<!-- 유경 - 쇼핑몰  매출코드번호 자동증가 -->
	<select id="getAddIncomeCode" resultType="ShopAddAccounting">
	 SELECT 
	 CONCAT('shop_income_', (SELECT LPAD(COUNT(*)+1,3,'0')
	 FROM k2_shop_income )) as addIncomeCode
	
	</select>
	
	<!-- 유경 - 쇼핑몰  매출등록 -->
	<insert id="addIncome" parameterType="ShopAddAccounting">
	INSERT INTO k2_shop_income
		(shopIncomeCode, 
		shopIsCode, 
		releaseCode, 
		shopMemberId, 
		shopIncomeGroupSlip, 
		refundZeroCheck, 
		finalIncomeVatImply, 
		finalIncomeVatNotImply, 
		shopIncomeDate, 
		shopIncomeRegDate)
	VALUES (
		#{addIncomeCode}
		,'40101'
		,#{releaseCode}
		,'shopid001'
		,#{groupslip}
		,'1'
		,#{renontax}
		,#{retax}
		,CURDATE()
		,CURDATE()
	);
	
	</insert>
	
	<!-- 유경 - 쇼핑몰  매출 조회-->
	<select id="getSelectIncome"  resultType="ShopAddAccounting">
		SELECT
		if(ISNULL(i.shopIncomeCode), '발행대상', '발행완료') AS addIncome,
		i.shopIncomeCode as shopIncomeCode,
		r.releaseCode,
		o.shopOrderCode,
		o.shopSlipNumber,
		o.shopOrderAmount,
		o.goodsPaymentAmount,
		ROUND((o.goodsPaymentAmount/1.1),0) AS nontax,
		cast(if(isnull(re.shopRefundCode),1,0)as INT) AS checkRefund,
		(ROUND((o.goodsPaymentAmount/1.1),0) * cast(if(isnull(re.shopRefundCode),1,0)as INT)) AS renontax,
		ROUND((ROUND((o.goodsPaymentAmount/1.1),0) * cast(if(isnull(re.shopRefundCode),1,0)as INT)) * 0.1,0) AS retax,
		c.shopPaymentDate,
		re.shopRefundCode,
		re.shopRefundDate,
		left(replace(CONCAT('쇼핑몰_상품_',o.shopSlipNumber),'전표',''),16) AS groupslip,
		r.shopPaymentCheckCode,
		i.shopIncomeFinish,
		i.shopIncomeFinishDate
	FROM
		k2_release AS r
		left join
		k2_shop_order AS o
		ON
		o.shopOrderCode = r.shopOrderCode
		left JOIN
		k2_shop_refund AS re
		ON
		re.releaseCode = r.releaseCode
		LEFT join
		k2_shop_paymentCheck AS c
		on
		c.shopPaymentCheckCode = r.shopPaymentCheckCode
		LEFT join
		k2_shop_income AS i
		on
		i.releaseCode = r.releaseCode
		WHERE i.shopIncomeCode IS NOT null
	ORDER BY (i.shopIncomeCode IS NOT NULL)
	, i.shopIncomeCode DESC
	</select>
	
	<!-- 유경 - 쇼핑몰  매출 조회 차트-->
	<select id = "getSelectIncomeChart" resultType="ShopAddAccounting">
		<!--  SELECT
			CONCAT(MONTH((i.shopIncomeDate)),'월')AS mon,
			sum(i.finalIncomeVatImply)AS chartPrice
		FROM
			k2_shop_income AS i
		WHERE YEAR(i.shopIncomeDate) = 2021
			GROUP BY mon-->
			SELECT
			sum(i.finalIncomeVatImply)AS chartPrice
			FROM
			k2_shop_income AS i
			WHERE YEAR(i.shopIncomeDate) = 2021
	</select>
	
	<!-- 유경 - 쇼핑몰 매출 마감  코드 확인 -->
	<select id="getModifyShopIncome" resultType="ShopAddAccounting">
		SELECT
			*
		FROM
			k2_shop_income
		WHERE
			shopIncomeCode = #{shopIncomeCode};
	</select>
	
	<update id="ShopIncomeFinish" parameterType="ShopAddAccounting">
		UPDATE k2_shop_income
		SET
			shopIncomeFinish=#{shopIncomeFinish},
			shopIncomeFinishDate=curdate()
		WHERE shopIncomeCode=#{shopIncomeCode};
	</update>
	
	<select id="getSelectTotalAccounting"  resultType="int">
		SELECT
			sum(t.shopTotalPrice) AS shopExpensePrice
		FROM
			k2_shop_totalAccounting AS t
		WHERE t.shopSalesSection = '비용'
		AND
			substring(t.shopGroupSlip,8,2) = '21'
	</select>
</mapper>